# 支付渠道密钥加密配置指南

为了提高系统安全性，我们对支付渠道密钥实施了加密存储。本文档提供了如何设置加密主密钥并执行密钥加密迁移的指南。

## 设置加密主密钥

系统使用 AES-256-GCM 算法进行加密，需要一个 32 字节（64 个十六进制字符）的主密钥。

### 生成加密主密钥

1. 使用以下命令生成一个安全的随机密钥（在终端中执行）:

```bash
# 在Linux/MacOS上
openssl rand -hex 32

# 在Windows上 (如果安装了OpenSSL)
openssl rand -hex 32

# 或者在Node.js中生成
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

2. 将生成的密钥添加到环境变量文件中：

```bash
# 在.env.admin文件中添加
ENCRYPTION_MASTER_KEY=您生成的64位十六进制密钥
```

**重要说明**：
- 不要在代码库中存储明文的密钥
- 每个环境（开发、测试、生产）应使用不同的密钥
- 请安全地备份密钥，如果丢失将无法解密数据
- 所有服务部署环境(.env.h5, .env.admin, .env)都需要配置相同的密钥

## 执行密钥加密迁移

完成加密主密钥配置后，需要执行迁移脚本对数据库中的现有密钥进行加密：

```bash
# 执行迁移脚本
npm run migrate

# 或直接运行特定迁移脚本
node scripts/003_encrypt_payment_channel_keys.js
```

迁移脚本将：
1. 自动从.env.admin文件加载环境变量
2. 检查支付渠道表中的所有记录
3. 跳过已经加密或没有密钥的记录
4. 加密剩余的明文密钥
5. 输出迁移统计信息

## 密钥轮换

建议定期轮换加密主密钥以增强安全性。轮换步骤如下：

1. 生成新的主密钥
2. 创建一个临时脚本，使用旧密钥解密所有数据并使用新密钥重新加密
3. 更新所有环境变量文件中的主密钥为新密钥
4. 执行临时脚本
5. 安全地删除临时脚本

**注意**：密钥轮换需要谨慎进行，确保备份原始数据和密钥。

## 故障排除

遇到加密相关问题时，请检查：

1. .env.admin文件中环境变量是否正确配置
2. 密钥长度是否符合要求（32字节/64十六进制字符）
3. 所有使用密钥的服务器和环境是否使用相同的密钥
4. 环境变量是否成功加载（可在应用启动日志中查看）

如果数据无法解密，可能是密钥不匹配或数据损坏。请使用备份恢复数据。 